# ========================================
# Production-Hardened Nginx Configuration
# Multi-Tenant JLPT (mikan.uz)
# ========================================
# FEATURES:
# - Dynamic subdomain routing (api.mikan.uz, *.mikan.uz)
# - HTTPS/TLS hardening with Let's Encrypt
# - WebSocket optimization for Daphne
# - Rate limiting (auth endpoints, API schema)
# - Security headers (HSTS, CSP, X-Frame-Options)
# - Gzip compression for JSON/CSS/JS
# - 100MB upload support with per-location restrictions
# ========================================

# ---------------------------
# Rate Limiting Zones
# ---------------------------
# Zone 1: Auth endpoints (login, register, token) - aggressive limit
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=10r/m;

# Zone 2: API schema/docs endpoints - moderate limit
limit_req_zone $binary_remote_addr zone=schema_limit:10m rate=30r/m;

# Zone 3: General API requests - generous limit
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;

# Zone 4: WebSocket connections - per-IP limit
limit_conn_zone $binary_remote_addr zone=ws_conn_limit:10m;

# ---------------------------
# Upstream Definitions
# ---------------------------
# Gunicorn (HTTP/REST API) - running on web containers via Docker Compose
upstream gunicorn {
    # In production, add multiple web containers:
    # server jlpt_web_1:8000 fail_timeout=10s max_fails=3;
    # server jlpt_web_2:8000 fail_timeout=10s max_fails=3;
    # server jlpt_web_3:8000 fail_timeout=10s max_fails=3;
    
    # For single container (development/testing):
    server web:8000 fail_timeout=10s max_fails=3;
    
    keepalive 32;  # Keep 32 persistent connections to backend
}

# Daphne (ASGI/WebSocket) - running on daphne containers
upstream daphne {
    # In production, add multiple daphne containers:
    # server jlpt_daphne_1:8001 fail_timeout=10s max_fails=3;
    # server jlpt_daphne_2:8001 fail_timeout=10s max_fails=3;
    
    # For single container:
    server daphne:8001 fail_timeout=10s max_fails=3;
    
    keepalive 64;  # More persistent connections for WebSocket reuse
}

# ---------------------------
# SSL/TLS Configuration (shared)
# ---------------------------
# Modern TLS settings for Let's Encrypt certificates
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
ssl_prefer_server_ciphers off;

# SSL session cache (1MB = ~4000 sessions)
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;

# OCSP Stapling (reduces SSL handshake time)
ssl_stapling on;
ssl_stapling_verify on;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

# ---------------------------
# 1) HTTP → HTTPS Global Redirect
# ---------------------------
server {
    listen 80;
    listen [::]:80;
    server_name api.mikan.uz *.mikan.uz mikan.uz www.mikan.uz;

    # Allow Certbot ACME challenge (required for Let's Encrypt)
    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    # Health check endpoint (allow HTTP for Docker health checks)
    location /health/ {
        proxy_pass http://gunicorn;
        access_log off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
    }

    # All other requests → HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ---------------------------
# 2) Main Landing Page (mikan.uz)
# ---------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name mikan.uz www.mikan.uz;

    # SSL certificates (Let's Encrypt via Certbot)
    ssl_certificate /etc/letsencrypt/live/mikan.uz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mikan.uz/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/mikan.uz/chain.pem;

    # HSTS (HTTP Strict Transport Security) - 1 year
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss://api.mikan.uz https://api.mikan.uz;" always;

    # Logging
    access_log /var/log/nginx/mikan_landing_access.log;
    error_log /var/log/nginx/mikan_landing_error.log;

    # Static landing page (SPA/marketing site)
    root /var/www/mikan-landing;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # Health check (proxied to Django)
    location /health/ {
        proxy_pass http://gunicorn;
        access_log off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
    }
}

# ---------------------------
# 3) API + Dynamic Tenant Subdomains (HTTPS)
# ---------------------------
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.mikan.uz *.mikan.uz;

    # SSL certificates (wildcard cert for *.mikan.uz + api.mikan.uz)
    # Certbot command: certbot certonly --dns-<provider> -d "*.mikan.uz" -d "api.mikan.uz"
    ssl_certificate /etc/letsencrypt/live/api.mikan.uz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.mikan.uz/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/api.mikan.uz/chain.pem;

    # ---------------------------
    # Security Headers
    # ---------------------------
    # HSTS - 1 year with subdomains (critical for preventing downgrade attacks)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Prevent MIME sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # XSS protection (legacy browsers)
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Content Security Policy (CSP) - allows WebSocket connections to same origin
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss://*.mikan.uz https://*.mikan.uz wss://api.mikan.uz https://api.mikan.uz;" always;

    # ---------------------------
    # Logging
    # ---------------------------
    access_log /var/log/nginx/jlpt_api_access.log;
    error_log /var/log/nginx/jlpt_api_error.log warn;

    # ---------------------------
    # Client Body Size
    # ---------------------------
    # Default: 10MB (covers most API requests)
    # Overridden to 100MB for /api/v1/materials/upload/ endpoint
    client_max_body_size 10M;

    # ---------------------------
    # Gzip Compression
    # ---------------------------
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml
        application/xml+rss
        application/x-javascript
        image/svg+xml;

    # ---------------------------
    # ACME Challenge (Let's Encrypt)
    # ---------------------------
    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    # ---------------------------
    # Health Check (no access log, no rate limit)
    # ---------------------------
    location /health/ {
        proxy_pass http://gunicorn;
        access_log off;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
    }

    # ---------------------------
    # Authentication Endpoints (AGGRESSIVE RATE LIMITING)
    # ---------------------------
    # Prevents brute-force attacks on login/register/token endpoints
    # Rate: 10 requests per minute per IP
    location ~ ^/api/v1/auth/(login|register|token|password-reset|verify-email)/ {
        # Rate limiting: 10 requests/minute, burst 5, no delay
        limit_req zone=auth_limit burst=5 nodelay;
        limit_req_status 429;

        # Custom error response for rate limit
        error_page 429 = @too_many_requests;

        proxy_pass http://gunicorn;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect off;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ---------------------------
    # API Schema/Docs Endpoints (MODERATE RATE LIMITING)
    # ---------------------------
    # Prevents excessive schema scraping
    # Rate: 30 requests per minute per IP
    location ~ ^/api/(schema|docs|redoc)/ {
        limit_req zone=schema_limit burst=10 nodelay;
        limit_req_status 429;
        error_page 429 = @too_many_requests;

        proxy_pass http://gunicorn;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect off;
    }

    # ---------------------------
    # Material Upload Endpoint (100MB SUPPORT)
    # ---------------------------
    # Allows 100MB uploads for materials (audio, documents, images)
    # Rate limiting: 100 requests/second per IP (generous for uploads)
    location ~ ^/api/v1/materials/upload/ {
        limit_req zone=api_limit burst=20 nodelay;
        
        # Override client_max_body_size to 100MB
        client_max_body_size 100M;
        
        # Increase timeouts for large file uploads
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        proxy_pass http://gunicorn;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect off;
        
        # Disable buffering for large uploads (stream to backend)
        proxy_request_buffering off;
    }

    # ---------------------------
    # WebSocket Proxy (Daphne) - OPTIMIZED
    # ---------------------------
    # Handles real-time exam progress, chat, notifications
    # Max 10 concurrent WebSocket connections per IP (prevents abuse)
    location /ws/ {
        # Connection limit: 10 concurrent per IP
        limit_conn ws_conn_limit 10;
        limit_conn_status 429;

        proxy_pass http://daphne;
        proxy_http_version 1.1;

        # WebSocket upgrade headers (CRITICAL)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;

        # WebSocket optimization
        proxy_buffering off;  # Disable buffering for real-time data
        proxy_cache off;      # No caching for WebSocket
        
        # Long-lived connection timeouts (24 hours for exam sessions)
        proxy_read_timeout 86400s;  # 24 hours
        proxy_send_timeout 86400s;  # 24 hours
        proxy_connect_timeout 60s;   # Initial connection: 1 minute
        
        # Buffer sizes for exam data (optimized for JSON payloads)
        proxy_buffer_size 16k;
        proxy_buffers 8 16k;
        proxy_busy_buffers_size 32k;
    }

    # ---------------------------
    # Static Files (Cache-Control Headers)
    # ---------------------------
    location /static/ {
        alias /var/www/mikan/staticfiles/;
        
        # Cache static assets for 30 days
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Security headers (inherited from server block)
        add_header X-Content-Type-Options "nosniff" always;
        
        # Gzip already enabled globally
        access_log off;  # Don't log static file requests
    }

    # ---------------------------
    # Media Files (User Uploads)
    # ---------------------------
    # If using S3, disable this and return 404 or redirect to S3
    location /media/ {
        alias /var/www/mikan/media/;
        
        # Cache media for 7 days
        expires 7d;
        add_header Cache-Control "public";
        
        # Security: Prevent execution of scripts in media directory
        location ~ \.(php|pl|py|jsp|asp|sh|cgi)$ {
            return 403;
        }
    }

    # ---------------------------
    # General API Requests (Rate Limited)
    # ---------------------------
    # Covers all other /api/v1/* endpoints
    # Rate: 100 requests/second per IP (generous for normal usage)
    location /api/ {
        limit_req zone=api_limit burst=50 nodelay;
        limit_req_status 429;
        error_page 429 = @too_many_requests;

        proxy_pass http://gunicorn;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect off;
        
        # Standard timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffering for API responses (helps with performance)
        proxy_buffering on;
        proxy_buffer_size 16k;
        proxy_buffers 8 16k;
    }

    # ---------------------------
    # Root / Catch-All (Proxied to Django)
    # ---------------------------
    location / {
        limit_req zone=api_limit burst=50 nodelay;

        proxy_pass http://gunicorn;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect off;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ---------------------------
    # Rate Limit Error Handler
    # ---------------------------
    location @too_many_requests {
        default_type application/json;
        return 429 '{"error":"Too many requests","detail":"Rate limit exceeded. Please try again later.","code":"rate_limit_exceeded"}';
    }
}

# ---------------------------
# 4) Fallback for Unknown Subdomains (Optional Security)
# ---------------------------
# Catches any subdomain not matching *.mikan.uz pattern
# Returns 444 (Nginx close connection without response)
server {
    listen 443 ssl http2 default_server;
    listen [::]:443 ssl http2 default_server;
    server_name _;

    # Use a self-signed cert or the main cert
    ssl_certificate /etc/letsencrypt/live/api.mikan.uz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.mikan.uz/privkey.pem;

    # Close connection without response (prevents info leakage)
    return 444;
}
