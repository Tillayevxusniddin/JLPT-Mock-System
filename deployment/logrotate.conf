/var/log/nginx/*.log {
    # Rotate daily if file size > 100MB or daily (whichever comes first)
    daily
    size 100M
    
    # Keep 14 days of backup logs (2 weeks)
    rotate 14
    
    # Compress old logs (gzip)
    compress
    delaycompress
    
    # Don't rotate empty files
    notifempty
    
    # Create new empty log file with specific permissions
    create 0640 www-data adm
    
    # Share postrotate script (run once per logrotate cycle)
    sharedscripts
    
    # Reload Nginx to use new log file
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
    
    # Also reload Nginx even if no logs to rotate
    prerotate
        if [ -d /etc/logrotate.d/httpd-prerotate.d ]; then \
            run-parts /etc/logrotate.d/httpd-prerotate.d; \
        fi
    endscript
}

# ========================================
# Application Logs
# ========================================
/app/logs/*.log {
    # Rotate daily or when file > 50MB
    daily
    size 50M
    
    # Keep 30 days of logs (1 month)
    rotate 30
    
    # Compress old logs
    compress
    delaycompress
    
    # Don't rotate empty files
    notifempty
    
    # Create new log file
    create 0640 www-data adm
    
    # Individual postrotate (Django restarts to reopen file handle)
    postrotate
        docker exec jlpt_web python manage.py send_signal SIGUSR1 2>/dev/null || true
    endscript
}

# ========================================
# Django Management Logs (optional, if enabled)
# ========================================
/var/log/jlpt/*.log {
    daily
    size 50M
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
}

# ========================================
# Celery Logs (if logging to file instead of systemd journal)
# ========================================
/var/log/celery/*.log {
    daily
    size 50M
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
}

# ========================================
# PostgreSQL Logs (if enabled, usually in /var/log/postgresql/)
# ========================================
/var/log/postgresql/*.log {
    daily
    size 100M
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 postgres postgres
    postrotate
        /usr/lib/postgresql/15/bin/pg_ctl logrotate || true
    endscript
}

# ========================================
# Redis Logs (if enabled)
# ========================================
/var/log/redis/*.log {
    daily
    size 50M
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 redis redis
}
